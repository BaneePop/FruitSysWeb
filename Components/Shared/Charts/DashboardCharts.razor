@page "/dashboard/charts" 
@using FruitSysWeb.Services.Interfaces
@using FruitSysWeb.Services.Models.Requests
@using FruitSysWeb.Utils.Charts
@inject IProizvodnjaService ProizvodnjaService
@inject IMagacinLagerService LagerService
@inject IJSRuntime JSRuntime
@inject IDashboardService DashboardService

<h3>Dashboard Charts</h3>

<div class="chart-container">
    <CurrentChart Title="Monthly Sales" DataLoader="@(service => service.GetMonthlySalesAsync())" />
    <CurrentChart Title="Revenue Trend" DataLoader="@(service => service.GetRevenueTrendAsync())" />
    <CurrentChart Title="Customer Growth" DataLoader="@(service => service.GetCustomerGrowthAsync())" />
</div>

@code {
    // Data properties
    public Dictionary<string, decimal>? KupciData { get; private set; }
    public Dictionary<string, decimal>? DobavljaciData { get; private set; }
    public Dictionary<string, decimal>? ProizvodnjaData { get; private set; }
    public Dictionary<string, decimal>? SirovineData { get; private set; }
    public Dictionary<string, decimal>? GotoviData { get; private set; }
    public Dictionary<string, decimal>? AmbalazeData { get; private set; }

    // Chart configurations
    private BarConfig? kupciConfig;
    private BarConfig? dobavljaciConfig;
    private BarConfig? proizvodnjaConfig;
    private PieConfig? sirovineConfig;
    private PieConfig? gotoviConfig;
    private PieConfig? ambalazeConfig;

    // Loading states
    public bool LoadingKupci { get; private set; }
    public bool LoadingDobavljaci { get; private set; }
    public bool LoadingProizvodnja { get; private set; }
    public bool LoadingSirovine { get; private set; }
    public bool LoadingGotovi { get; private set; }
    public bool LoadingAmbalaza { get; private set; }

    private DateTime lastUpdateTime = DateTime.Now;

    public bool IsAnyLoading => LoadingKupci || LoadingDobavljaci || LoadingProizvodnja || 
                               LoadingSirovine || LoadingGotovi || LoadingAmbalaza;

    protected override async Task OnInitializedAsync()
    {
        await LoadAllCharts();
    }

    public async Task LoadAllCharts()
    {
        var tasks = new List<Task>
        {
            RefreshKupci(),
            RefreshDobavljaci(),
            RefreshProizvodnja(),
            RefreshSirovine(),
            RefreshGotovi(),
            RefreshAmbalaza()
        };

        await Task.WhenAll(tasks);
        lastUpdateTime = DateTime.Now;
        StateHasChanged();
    }

    private async Task RefreshKupci()
    {
        if (LoadingKupci) return;

        LoadingKupci = true;
        StateHasChanged();

        try
        {
            var filter = CreateDefaultFilter();
            KupciData = await ProizvodnjaService.UcitajTopKupcePoKilogramima(filter);

            if (KupciData?.Any() == true)
            {
                kupciConfig = ChartHelper.CreateCustomBarChart(
                    KupciData,
                    "Količina (kg)",
                    "rgba(40, 167, 69, 0.8)",
                    5
                );
            }
            else
            {
                kupciConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Greška pri učitavanju top kupaca: {ex.Message}");
            KupciData = null;
            kupciConfig = null;
        }
        finally
        {
            LoadingKupci = false;
            StateHasChanged();
        }
    }

    private async Task RefreshDobavljaci()
    {
        if (LoadingDobavljaci) return;

        LoadingDobavljaci = true;
        StateHasChanged();

        try
        {
            var filter = CreateDefaultFilter();
            DobavljaciData = await ProizvodnjaService.UcitajTopDobavljacePoKilogramima(filter);

            if (DobavljaciData?.Any() == true)
            {
                dobavljaciConfig = ChartHelper.CreateCustomBarChart(
                    DobavljaciData,
                    "Količina (kg)",
                    "rgba(220, 53, 69, 0.8)",
                    5
                );
            }
            else
            {
                dobavljaciConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Greška pri učitavanju top dobavljača: {ex.Message}");
            DobavljaciData = null;
            dobavljaciConfig = null;
        }
        finally
        {
            LoadingDobavljaci = false;
            StateHasChanged();
        }
    }

    private async Task RefreshProizvodnja()
    {
        if (LoadingProizvodnja) return;

        LoadingProizvodnja = true;
        StateHasChanged();

        try
        {
            var filter = CreateDefaultFilter();
            ProizvodnjaData = await ProizvodnjaService.UcitajProizvodnjuPoArtiklima(filter);

            if (ProizvodnjaData?.Any() == true)
            {
                proizvodnjaConfig = ChartHelper.CreateCustomBarChart(
                    ProizvodnjaData,
                    "Količina (kg)",
                    "rgba(13, 110, 253, 0.8)",
                    8
                );
            }
            else
            {
                proizvodnjaConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Greška pri učitavanju proizvodnje po artiklima: {ex.Message}");
            ProizvodnjaData = null;
            proizvodnjaConfig = null;
        }
        finally
        {
            LoadingProizvodnja = false;
            StateHasChanged();
        }
    }

    private async Task RefreshSirovine()
    {
        if (LoadingSirovine) return;

        LoadingSirovine = true;
        StateHasChanged();

        try
        {
            SirovineData = await LagerService.UcitajStrukturuSirovina();

            if (SirovineData?.Any() == true)
            {
                sirovineConfig = ChartHelper.CreateCustomPieChart(
                    SirovineData,
                    "",
                    5
                );
            }
            else
            {
                sirovineConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Greška pri učitavanju strukture sirovina: {ex.Message}");
            SirovineData = null;
            sirovineConfig = null;
        }
        finally
        {
            LoadingSirovine = false;
            StateHasChanged();
        }
    }

    private async Task RefreshGotovi()
    {
        if (LoadingGotovi) return;

        LoadingGotovi = true;
        StateHasChanged();

        try
        {
            GotoviData = await LagerService.UcitajStrukturuGotovihProizvoda();

            if (GotoviData?.Any() == true)
            {
                gotoviConfig = ChartHelper.CreateCustomPieChart(
                    GotoviData,
                    "",
                    5
                );
            }
            else
            {
                gotoviConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Greška pri učitavanju strukture gotovih proizvoda: {ex.Message}");
            GotoviData = null;
            gotoviConfig = null;
        }
        finally
        {
            LoadingGotovi = false;
            StateHasChanged();
        }
    }

    private async Task RefreshAmbalaza()
    {
        if (LoadingAmbalaza) return;

        LoadingAmbalaza = true;
        StateHasChanged();

        try
        {
            AmbalazeData = await LagerService.UcitajStrukturuAmbalaze();

            if (AmbalazeData?.Any() == true)
            {
                ambalazeConfig = ChartHelper.CreateCustomPieChart(
                    AmbalazeData,
                    "",
                    5
                );
            }
            else
            {
                ambalazeConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Greška pri učitavanju strukture ambalaže: {ex.Message}");
            AmbalazeData = null;
            ambalazeConfig = null;
        }
        finally
        {
            LoadingAmbalaza = false;
            StateHasChanged();
        }
    }

    private FilterRequest CreateDefaultFilter()
    {
        return new FilterRequest
        {
            OdDatum = DateTime.Now.AddMonths(-1),
            DoDatum = DateTime.Now
        };
    }
}

<style>
    .quick-stats-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        height: fit-content;
    }

    .quick-stats-card h5 {
        color: #0f5132;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .stat-value {
        font-weight: 600;
        color: #0f5132;
    }

    .rotating {
        animation: rotateAnim 1s linear infinite;
    }

   @*  /* ESCAPE @ znakove za keyframes */ *@
    @@keyframes rotateAnim {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>